{"files":[{"id":"7245cf3b-2a85-4825-bebe-db16a04fdc7c","name":"程式碼","type":"server_js","source":"//LINE BOT TOKEN\nvar CHANNEL_ACCESS_TOKEN \u003d \u0027jNfwdBNWnqCHkT1GzqsJc+IJKsFdtztJEklxgnBQO7OpxnII48PniFGym7A1R8VZ9l4VaoFf//ej74ymPAn1KYECLh6khWptPCxeaY6+D4neLTl8+l8Lgxi5L652vYXmQK8Gl6dUZu27Sby6XnLEOwdB04t89/1O/w1cDnyilFU\u003d\u0027;\n//指定試算表\nvar SpreadSheet \u003d SpreadsheetApp.openById(\"1Aj9gBDOPLwDuiGR3pHPE1H_wO9ut-u2brc8Z272IiP8\");\n\n//抓取IP位置\nfunction doGet(e) {\n  return ContentService.createTextOutput(UrlFetchApp.fetch(\"http://ip-api.com/json\"));\n}\n\n//處理Line server傳進來訊息，再送出訊息到用戶端\nfunction doPost(e) {\n\n  var events \u003d JSON.parse(e.postData.contents).events[0];\n  var reply_token \u003d events.replyToken;\n\n  if (typeof reply_token \u003d\u003d\u003d \u0027undefined\u0027)\n    return;\n  \n  retMsg \u003d ProcMsg(events);\n  console.log(retMsg);\n\n  return ContentService.createTextOutput(JSON.stringify({ \u0027content\u0027: \u0027post ok\u0027 })).setMimeType(ContentService.MimeType.JSON);\n}\n\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\nfunction ProcMsg(events) {\n  var massage_time \u003d UNIXToTime(events.timestamp);\n  var userName \u003d getprofile (events.source.userId);\n  var massage_type \u003d events.message.type;\n  var massage_text \u003d events.message.text;\n  if (typeof massage_text \u003d\u003d\u003d \u0027undefined\u0027){\n    massage_text \u003d events.message.type;\n  }\n  var retMsg;\n\n  switch (massage_type) {\n    case \u0027text\u0027:\n      retMsg \u003d massage_text;\n      writesheet (massage_time, userName, massage_type, retMsg);\n      break;\n\n    case \u0027image\u0027:    \n      var blob \u003d getImg(events.message.id);\n      var upload_result \u003d driveUPLOAD(blob, massage_time);  //上傳到Google Drive\n      var file \u003d upload_result[1]\n      \n      file.setName(getTimeStamp());\n      \n      var fileNAME \u003d file.getName()\n      var fileID \u003d file.getId()\n      var fileURL \u003d file.getUrl()\n\n      retMsg \u003d \u0027file: \u0027 + fileNAME + \u0027： \u0027 + fileURL;\n      writesheet (massage_time, userName, massage_type, retMsg);\n      break;\n\n    case \u0027sticker\u0027:\n      retMsg \u003d \u0027packageId: \u0027 + events.message.packageId + \u0027, stickerId: \u0027 + events.message.stickerId;\n      writesheet (massage_time, userName, massage_type, retMsg);\n      break;\n  }\n  return retMsg;\n}\n\n//\nfunction UNIXToTime (input) {\n  var dt \u003d new Date(input);\n  Y \u003d dt.getFullYear() + \u0027-\u0027;\n  M \u003d (dt.getMonth()+1 \u003c 10 ? \u00270\u0027+(dt.getMonth()+1) : dt.getMonth()+1) + \u0027-\u0027;\n  D \u003d dt.getDate() + \u0027 \u0027;\n  h \u003d dt.getHours() + \u0027:\u0027;\n  m \u003d dt.getMinutes() + \u0027:\u0027;\n  s \u003d dt.getSeconds(); \n  return Y+M+D+h+m+s;\n}\n\nfunction getTimeStamp () {\n  var d \u003d new Date();\n  h \u003d d.getHours();\n  m \u003d d.getMinutes();\n  s \u003d d.getSeconds(); \n  h \u003d (\"0\" + h).slice(-2);\n  m \u003d (\"0\" + m).slice(-2);\n  s \u003d (\"0\" + s).slice(-2);\n  return h+m+s;\n}\n\nfunction getImg (msgID) {\n  var url \u003d \u0027https://api.line.me/v2/bot/message/\u0027 + msgID + \u0027/content\u0027;\n  var header \u003d {\n    \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n  }\n  var options \u003d {\n    \u0027headers\u0027: header,\n    \u0027method\u0027: \u0027GET\u0027\n  }\n  var response \u003d UrlFetchApp.fetch(url, options);\n  var content_type \u003d response.getAllHeaders()[\"Content-Type\"]\n  var blob \u003d response.getAs(content_type) //EX: image/png\n  return blob;\n}\n\nfunction driveUPLOAD (blob, massage_time) {\n  try {\n    var parentFolderName \u003d \"message_record照片資料夾\";\n    var parentFolders \u003d DriveApp.getFoldersByName(parentFolderName);\n    var parentFolder;\n    \n    //由於可能有同名稱的資料夾，這邊做預設處理\n    if (parentFolders.hasNext())\n    { parentFolder \u003d parentFolders.next(); }\n    else //如果資料夾不存在就自動建立\n    { parentFolder \u003d DriveApp.createFolder(parentFolderName); }\n\n    //處理檔案寫入工作\n    if (blob !\u003d \u0027undefined\u0027) {\n      splitmessage \u003d massage_time.split(\" \");\n      var subFolderName \u003d splitmessage[0];\n      var subFolders \u003d parentFolder.getFoldersByName(subFolderName);\n      var subFolder;\n      \n      //由於可能有同名稱的資料夾，這邊做預設處理\n      if (subFolders.hasNext())\n      { subFolder \u003d subFolders.next(); }\n      else //如果資料夾不存在就自動建立子資料夾\n      { subFolder \u003d parentFolder.createFolder(subFolderName); }\n      \n      //寫入資料\n      var file \u003d subFolder.createFile(blob);\n    }\n    return [\u0027圖片訊息上傳成功。\u0027, file];\n  }\n  catch (error)\n  { \n    return \"Upload failed! Reason: \" + error.toString();\n  }\n}\n\nfunction getprofile (UID) {\n  var header \u003d {\n    \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n    \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n  }\n  var options \u003d {\n    \u0027headers\u0027: header,\n  }\n  url_profile \u003d \"https://api.line.me/v2/bot/profile/\" + UID\n  \n  try {\n    var response \u003d UrlFetchApp.fetch(url_profile, options);\n    var rJSON \u003d JSON.parse(response);\n    return rJSON.displayName;\n  } catch (e) {\n    return \u0027LINE_DEV\u0027;\n  }\n}\n\nfunction writesheet (massage_time, userName, massage_type, massage_text) {\n  var Sheet \u003d SpreadSheet.getSheetByName(\"工作表1\");\n  var LastRow \u003d Sheet.getLastRow();\n  \n  //--開始寫入資料--\n  Sheet.getRange(LastRow+1, 1).setValue(massage_time);\n  Sheet.getRange(LastRow+1, 2).setValue(userName);\n  Sheet.getRange(LastRow+1, 3).setValue(massage_type);\n  Sheet.getRange(LastRow+1, 4).setValue(massage_text);\n}"},{"id":"5bfa343d-7fb7-49b6-be74-66ab9ad4ef80","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Hong_Kong\",\n  \"dependencies\": {\n  },\n  \"webapp\": {\n    \"access\": \"ANYONE_ANONYMOUS\",\n    \"executeAs\": \"USER_DEPLOYING\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\"\n}"}]}